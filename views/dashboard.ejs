<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f1419">
    <title>Dashboard - Polynumba</title>
    <link rel="icon" type="image/png" href="/images/polunumba_logo.png">
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/dashboard.css">
</head>
<body>
    <!-- Main Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-left">
                <div class="logo">
                    <div class="logo-container">
                        <img src="/images/polunumba_logo.png" alt="Polynumba Logo" class="logo-image">
                        <span class="logo-text">POLYNUMBA</span>
                    </div>
                </div>
            </div>
            <div class="nav-right">
                <div class="user-balance-nav">
                    <span class="balance-label-nav">Balance:</span>
                    <span class="balance-amount-nav">â‚¦40,000.00</span>
                </div>
                <div class="user-menu">
                    <span class="username-display"><%= typeof user !== 'undefined' && user && user.username ? user.username : 'User' %></span>
                    <form action="/logout" method="POST" style="display: inline;">
                        <button type="submit" class="btn-logout">Logout</button>
                    </form>
                </div>
                <button class="mobile-menu-toggle" id="mobile-menu-toggle" aria-label="Open menu">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
            </div>
        </div>
    </nav>

    <!-- Mobile Menu -->
    <div class="mobile-menu-overlay" id="mobile-menu-overlay"></div>
    <div class="mobile-menu" id="mobile-menu">
        <div class="mobile-menu-header">
            <div class="logo-container">
                <img src="/images/polunumba_logo.png" alt="Polynumba Logo" class="logo-image" style="height: 28px;">
                <span class="logo-text" style="font-size: 1.125rem;">POLYNUMBA</span>
            </div>
            <button class="mobile-menu-close" id="mobile-menu-close" aria-label="Close menu">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="mobile-menu-content">
            <div class="user-balance-nav" style="margin-bottom: 16px; width: 100%; justify-content: space-between;">
                <span class="balance-label-nav">Balance:</span>
                <span class="balance-amount-nav">â‚¦40,000.00</span>
            </div>
            <ul class="mobile-menu-nav">
                <li><a href="/dashboard" class="active">Dashboard</a></li>
                <li><a href="/how-to-play" target="_blank">How to Play</a></li>
            </ul>
            <div class="mobile-menu-actions">
                <div style="text-align: center; padding: 12px 0; color: var(--text-secondary);">
                    Logged in as <strong style="color: var(--text-primary);"><%= typeof user !== 'undefined' && user && user.username ? user.username : 'User' %></strong>
                </div>
                <form action="/logout" method="POST" style="width: 100%;">
                    <button type="submit" class="btn-logout" style="width: 100%; padding: 12px;">Logout</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Balance Display at Top -->
    <div class="balance-header">
        <div class="balance-header-container">
            <div class="balance-display-large">
                <span class="balance-label-large">Account Balance</span>
                <span class="balance-amount-large" id="account-balance-top">â‚¦40,000.00</span>
            </div>
            <div class="balance-actions">
                <button class="btn-deposit">Deposit</button>
                <button class="btn-withdraw">Withdraw</button>
            </div>
        </div>
    </div>

    <!-- Dashboard Tabs -->
    <div class="dashboard-tabs">
        <div class="dashboard-tabs-container">
            <!-- Desktop: General Play Game tab -->
            <button class="dashboard-tab desktop-play-tab active" onclick="switchDashboardTab('play', 4)">Play Game</button>
            <!-- Mobile: Specific game type tabs -->
            <button class="dashboard-tab mobile-game-tab active" data-tab-type="game" onclick="switchDashboardTab('play', 4)">4-Number</button>
            <button class="dashboard-tab mobile-game-tab" data-tab-type="game" onclick="switchDashboardTab('play', 3)">3-Number</button>
            <!-- Both: My Betting Details tab -->
            <button class="dashboard-tab" onclick="switchDashboardTab('details')">My Betting Details</button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Play Game Tab Content -->
        <div id="play-tab" class="tab-content active">
            <div class="content-layout">
                <!-- Left Sidebar -->
                <aside class="left-sidebar">
                    <div class="sidebar-section">
                        <div class="sidebar-header">
                            <h3>Quick Filters</h3>
                        </div>
                        <div class="filter-group">
                            <input type="text" placeholder="Search..." class="filter-search">
                        </div>
                        <div class="filter-group practice-mode-section">
                            <h4 class="filter-title">Play Mode</h4>
                            <div class="mode-toggle">
                                <button class="mode-btn active" data-mode="real" onclick="switchPlayMode('real')">
                                    <span style="font-size: 1.2rem; font-weight: bold;">â‚¦</span>
                                    <span>Real Money</span>
                                </button>
                                <button class="mode-btn" data-mode="demo" onclick="switchPlayMode('demo')">
                                    <span style="font-size: 1.2rem; font-weight: bold;">â‚¦</span>
                                    <span>Practice Mode</span>
                                </button>
                            </div>
                            <div class="mode-info" id="demo-mode-info" style="display: none;">
                                <p class="mode-description">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="12" y1="16" x2="12" y2="12"></line>
                                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                                    </svg>
                                    Playing with demo funds. No real money used.
                                </p>
                                <div class="demo-balance">
                                    Demo Balance: <strong id="demo-balance-display">â‚¦100,000.00</strong>
                                </div>
                            </div>
                        </div>
                        <div class="filter-group">
                            <h4 class="filter-title">Game Types</h4>
                            <div class="filter-list">
                                <div class="filter-item active" data-game-type="4" onclick="switchGameType(4)">
                                    <span>4-Number Prediction</span>
                                    <span class="count">(12)</span>
                                </div>
                                <div class="filter-item" data-game-type="3" onclick="switchGameType(3)">
                                    <span>3-Number Prediction</span>
                                    <span class="count">(8)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>

                <!-- Center Content -->
                <div class="center-content">
                    <!-- Promotional Banner -->
                    <div class="promo-banner">
                        <div class="promo-content">
                            <h2>Win Big with Polynumba</h2>
                            <p>Predict correctly and win Big!</p>
                            <a href="/how-to-play" target="_blank" class="promo-link">Learn how to play <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle; margin-left: 4px;"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg></a>
                        </div>
                    </div>

                    <!-- Game Interface -->
                    <div class="game-panel" id="game-panel">
                        <div class="panel-header">
                            <h2 id="game-title">4-Number Prediction</h2>
                            <div class="start-game-section">
                                <button type="button" id="start-game-btn" class="btn-start-game" style="display: none;">Start Game</button>
                                <div id="generated-numbers-display" class="generated-numbers-display" style="display: none;">
                                    <span class="numbers-placeholder">* * * *</span>
                                </div>
                            </div>
                    </div>

                    <div class="game-interface">
                            <div class="game-instructions">
                                <p id="game-instruction">Step 1: Select your bet amount</p>
                                
                                <div class="bet-amount-display" id="bet-amount-display" style="display: none;">
                                    <span>Bet Amount: <strong id="current-bet-amount">â‚¦0.00</strong></span>
                                </div>
                                
                                <!-- Step 2: Attempts Selection (hidden initially) -->
                                <div class="attempts-selector" id="attempts-selector-step" style="display: none;">
                                    <label for="attempts-select">Step 2: Choose Attempts:</label>
                                    <select id="attempts-select" class="attempts-dropdown" onchange="updateOddsFromAttempts()">
                                        <option value="">Select attempts...</option>
                                        <option value="2">2 Attempts (10x odds)</option>
                                        <option value="3">3 Attempts (8x odds)</option>
                                        <option value="4">4 Attempts (6x odds)</option>
                                        <option value="5">5 Attempts (4x odds)</option>
                                        <option value="6">6 Attempts (3x odds)</option>
                                    </select>
                                </div>
                                
                                <div class="attempts-info" style="display: none;">
                                    <span>Remaining Attempts: <strong id="remaining-attempts">3</strong></span>
                                </div>
                            </div>

                            <!-- Message Display Area -->
                            <div id="bet-message-area" class="bet-message-area" style="display: none;">
                                <div id="bet-message" class="bet-message"></div>
                            </div>

                            <form action="/guess" method="POST" class="guess-form" id="guess-form">
                                <input type="hidden" name="gameType" id="game-type" value="4">
                                <input type="hidden" name="attemptsUsed" id="attempts-used" value="0">
                                
                                <!-- Step 1: Bet Amount Section -->
                                <div class="bet-section" id="bet-section-step">
                                    <label class="section-label">Bet Amount</label>
                                    <div class="bet-controls">
                                        <div class="quick-bet-buttons">
                                            <button type="button" class="quick-bet">â‚¦100</button>
                                            <button type="button" class="quick-bet">â‚¦500</button>
                                            <button type="button" class="quick-bet">â‚¦1,000</button>
                                            <button type="button" class="quick-bet">â‚¦5,000</button>
                                        </div>
                                        <div class="bet-input-container">
                                            <span class="currency-symbol">â‚¦</span>
                                            <input type="number" name="betAmount" id="bet-amount" class="bet-input" placeholder="Enter amount..." step="0.01" min="1">
                                        </div>
                                    </div>
                                </div>

                                <!-- Number Selection (hidden during setup, shown after game starts) -->
                                <div class="number-selection" id="number-selection-section" style="display: none;">
                                    <label class="section-label">Your Numbers</label>
                                    <div class="number-inputs" id="number-inputs-container">
                                        <input type="number" name="guess1" id="guess1" min="0" max="9" required 
                                               class="number-input" placeholder="0">
                                        <input type="number" name="guess2" id="guess2" min="0" max="9" required 
                                               class="number-input" placeholder="0">
                                        <input type="number" name="guess3" id="guess3" min="0" max="9" required 
                                               class="number-input" placeholder="0">
                                        <input type="number" name="guess4" id="guess4" min="0" max="9" required 
                                               class="number-input" placeholder="0">
                                    </div>
                                </div>

                                <div class="form-actions" id="form-actions-section" style="display: none;">
                                    <button type="submit" class="btn-place-bet">Check</button>
                                </div>
                            </form>

                            <div class="game-info">
                                <div class="info-row">
                                    <span>Potential Win:</span>
                                    <span class="win-amount" id="potential-win">â‚¦0.00</span>
                                </div>
                                <div class="info-row">
                                    <span>Current Odds:</span>
                                    <span id="odds-display">8.00x</span>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Right Sidebar -->
                <aside class="right-sidebar">
                    <div class="stats-card">
                        <h4>Today's Stats</h4>
                        <div class="stats-list">
                            <div class="stat-row">
                                <span>Total Bets:</span>
                                <span>1,234</span>
                            </div>
                            <div class="stat-row">
                                <span>Winners:</span>
                                <span>89</span>
                            </div>
                            <div class="stat-row">
                                <span>Total Payout:</span>
                                <span>â‚¦45,678</span>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>

        <!-- My Betting Details Tab Content -->
        <div id="details-tab" class="tab-content">
            <div class="dashboard-container">
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon balance-icon">â‚¦</div>
                        <div class="stat-content">
                            <h3>Account Balance</h3>
                            <p class="stat-value" id="account-balance">â‚¦40,000.00</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon win-icon">âœ“</div>
                        <div class="stat-content">
                            <h3>Total Wins</h3>
                            <p class="stat-value">â‚¦0.00</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon bet-icon">ðŸŽ¯</div>
                        <div class="stat-content">
                            <h3>Total Bets</h3>
                            <p class="stat-value">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon win-rate-icon">%</div>
                        <div class="stat-content">
                            <h3>Win Rate</h3>
                            <p class="stat-value">0%</p>
                        </div>
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="dashboard-content">
                    <!-- Left Column -->
                    <div class="dashboard-left">
                        <!-- Recent Activity -->
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h2>Recent Activity</h2>
                                <button class="btn-view-all">View All</button>
                            </div>
                            <div class="activity-list" id="activity-list">
                                <!-- Activity items will be loaded dynamically -->
                            </div>
                        </div>

                        <!-- Betting History -->
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h2>Betting History</h2>
                                <div class="filter-tabs">
                                    <button class="filter-tab active" data-filter="all" onclick="filterHistory('all')">All</button>
                                    <button class="filter-tab" data-filter="won" onclick="filterHistory('won')">Wins</button>
                                    <button class="filter-tab" data-filter="lost" onclick="filterHistory('lost')">Losses</button>
                                </div>
                            </div>
                            <div class="history-table-container">
                                <table class="history-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Game Type</th>
                                            <th>Numbers</th>
                                            <th>Bet Amount</th>
                                            <th>Status</th>
                                            <th>Win Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody id="history-table-body">
                                        <!-- History rows will be loaded dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="dashboard-right">
                        <!-- Account Summary -->
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h2>Account Summary</h2>
                            </div>
                            <div class="summary-list">
                                <div class="summary-item">
                                    <span>Total Deposited:</span>
                                    <span class="summary-value">â‚¦10,000</span>
                                </div>
                                <div class="summary-item">
                                    <span>Total Withdrawn:</span>
                                    <span class="summary-value">â‚¦0.00</span>
                                </div>
                                <div class="summary-item">
                                    <span>Total Winnings:</span>
                                    <span class="summary-value positive">â‚¦14,000</span>
                                </div>
                                <div class="summary-item">
                                    <span>Total Losses:</span>
                                    <span class="summary-value negative">â‚¦4,000</span>
                                </div>
                                <div class="summary-item total">
                                    <span>Net Profit:</span>
                                    <span class="summary-value positive">â‚¦10,000</span>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-section">
                <h4>Polynumba</h4>
                <p>Professional number prediction platform</p>
            </div>
            <div class="footer-section">
                <h4>Quick Links</h4>
                <ul>
                    <li><a href="/how-to-play" target="_blank">How to Play</a></li>
                    <li><a href="#">Rules</a></li>
                    <li><a href="#">FAQ</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Support</h4>
                <ul>
                    <li><a href="#">Contact Us</a></li>
                    <li><a href="#">Terms of Service</a></li>
                    <li><a href="#">Privacy Policy</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Responsible Gaming</h4>
                <p>18+ Only. Play responsibly.</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2024 Polynumba. All rights reserved.</p>
        </div>
    </footer>

    <!-- Bet Details Modal -->
    <div id="bet-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Bet Details</h2>
                <button class="modal-close" onclick="closeBetModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="bet-detail-section">
                    <div class="bet-detail-row">
                        <span class="detail-label">Game Type:</span>
                        <span class="detail-value" id="modal-game-type">-</span>
                    </div>
                    <div class="bet-detail-row">
                        <span class="detail-label">Your Prediction:</span>
                        <span class="detail-value bet-numbers-display" id="modal-user-numbers">-</span>
                    </div>
                    <div class="bet-detail-row">
                        <span class="detail-label">Winning Numbers:</span>
                        <span class="detail-value bet-numbers-display" id="modal-winning-numbers">-</span>
                    </div>
                    <div class="bet-detail-row">
                        <span class="detail-label">Bet Amount:</span>
                        <span class="detail-value" id="modal-bet-amount">-</span>
                    </div>
                    <div class="bet-detail-row">
                        <span class="detail-label">Result:</span>
                        <span class="detail-value" id="modal-result">-</span>
                    </div>
                    <div class="bet-detail-row">
                        <span class="detail-label">Win Amount:</span>
                        <span class="detail-value" id="modal-win-amount">-</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal-close" onclick="closeBetModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Celebration Modal -->
    <div id="celebration-modal" class="modal celebration-modal">
        <div class="modal-content celebration-modal-content">
            <div class="celebration-header">
                <div class="celebration-icon">ðŸŽ‰</div>
                <h2 class="celebration-title">Congratulations!</h2>
                <p class="celebration-subtitle">You Won!</p>
            </div>
            <div class="celebration-body">
                <div class="win-amount-display">
                    <span class="win-label">You Won:</span>
                    <span class="win-amount-celebration" id="celebration-win-amount">â‚¦0.00</span>
                </div>
                <p class="celebration-message">Great prediction! Your winnings have been added to your balance.</p>
            </div>
            <div class="celebration-footer">
                <button class="btn-celebration-close" onclick="closeCelebrationModal()">Awesome!</button>
            </div>
        </div>
    </div>

    <script>
        // Scroll to top on page load
        window.addEventListener('load', function() {
            window.scrollTo(0, 0);
        });
        
        // Also scroll to top immediately
        window.scrollTo(0, 0);

        // Dashboard Tab Switching
        function switchDashboardTab(tab, gameType) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.dashboard-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            if (tab === 'play') {
                document.getElementById('play-tab').classList.add('active');
                
                // Switch game type if provided
                if (gameType) {
                    if (typeof switchGameType === 'function') {
                        switchGameType(gameType);
                    }
                }
                
                // Activate the play tab button(s)
                // Activate desktop play tab
                const desktopPlayTab = document.querySelector('.dashboard-tab.desktop-play-tab');
                if (desktopPlayTab) {
                    desktopPlayTab.classList.add('active');
                }
                
                // Activate the correct mobile game type tab
                document.querySelectorAll('.dashboard-tab.mobile-game-tab').forEach(btn => {
                    const btnText = btn.textContent.trim();
                    if ((gameType === 4 && btnText.includes('4-Number')) || 
                        (gameType === 3 && btnText.includes('3-Number'))) {
                        btn.classList.add('active');
                    }
                });
            } else {
                document.getElementById('details-tab').classList.add('active');
                // Activate My Betting Details tab (find it by onclick attribute)
                document.querySelectorAll('.dashboard-tab').forEach(btn => {
                    if (btn.onclick && btn.onclick.toString().includes("'details'")) {
                        btn.classList.add('active');
                    }
                });
            }
        }

        // Game Type Switching (same as index page)
        let currentGameType = 4;
        let attemptsUsed = 0;
        let maxAttempts = 3;
        let selectedAttempts = 3; // User-selected attempts
        let currentOdds = 8; // Current odds based on attempts
        let playMode = 'real'; // 'real' or 'demo'
        let demoBalance = 100000; // Demo balance in Naira
        
        // Game type configuration
        const attemptsConfig = {
            3: 3,  // 3-number game has 3 max attempts
            4: 3   // 4-number game has 3 max attempts
        };
        
        // Base odds for game types
        const odds = {
            3: 100,  // 3-number prediction base odds
            4: 1000  // 4-number prediction base odds
        };
        
        // Attempts to Odds mapping (inversely proportional)
        const attemptsToOdds = {
            2: 10,
            3: 8,
            4: 6,
            5: 4,
            6: 3
        };

        // Load demo balance from localStorage
        function loadDemoBalance() {
            const saved = localStorage.getItem('polynumba_demo_balance');
            if (saved) {
                demoBalance = parseFloat(saved);
            }
            updateDemoBalanceDisplay();
        }

        // Save demo balance to localStorage
        function saveDemoBalance() {
            localStorage.setItem('polynumba_demo_balance', demoBalance.toString());
            updateDemoBalanceDisplay();
        }

        // Update demo balance display
        function updateDemoBalanceDisplay() {
            const display = document.getElementById('demo-balance-display');
            if (display) {
                display.textContent = `â‚¦${demoBalance.toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }
        }

        // Switch play mode
        function switchPlayMode(mode) {
            playMode = mode;
            
            // Update active button
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-mode') === mode) {
                    btn.classList.add('active');
                }
            });
            
            // Show/hide demo mode info
            const demoInfo = document.getElementById('demo-mode-info');
            if (demoInfo) {
                demoInfo.style.display = mode === 'demo' ? 'block' : 'none';
            }
            
            // Update UI to reflect mode
            if (mode === 'demo') {
                showBetMessage('You are now in Practice Mode. Play with demo funds to learn the game!', 'info');
                updateDemoBalanceDisplay();
            } else {
                hideBetMessage();
            }
        }

        // Generate random numbers for demo mode
        function generateDemoNumbers(count) {
            const availableNumbers = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
            // Shuffle array
            for (let i = availableNumbers.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [availableNumbers[i], availableNumbers[j]] = [availableNumbers[j], availableNumbers[i]];
            }
            return availableNumbers.slice(0, count);
        }

        // Initialize demo balance on page load
        loadDemoBalance();

        // Update odds based on selected attempts
        function updateOddsFromAttempts() {
            const attemptsSelect = document.getElementById('attempts-select');
            const startBtn = document.getElementById('start-game-btn');
            const instruction = document.getElementById('game-instruction');
            
            if (attemptsSelect.value) {
                selectedAttempts = parseInt(attemptsSelect.value);
                currentOdds = attemptsToOdds[selectedAttempts];
                maxAttempts = selectedAttempts;
                
                // Update odds display
                document.getElementById('odds-display').textContent = `${currentOdds}.00x`;
                
                // Update remaining attempts display
                document.getElementById('remaining-attempts').textContent = selectedAttempts;
                
                // Recalculate potential win
                calculatePotentialWin();
                
                // Show step 3: start button
                startBtn.style.display = 'inline-block';
                instruction.textContent = 'Step 3: Click "Start Game" to begin';
            } else {
                // Hide start button if attempts not selected
                startBtn.style.display = 'none';
                instruction.textContent = 'Step 2: Choose your number of attempts';
            }
        }

        // Calculate potential win
        function calculatePotentialWin() {
            const betAmount = parseFloat(document.getElementById('bet-amount').value) || 0;
            const potentialWin = betAmount * currentOdds;
            
            document.getElementById('potential-win').textContent = `â‚¦${potentialWin.toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        // Switch game type
        function switchGameType(type) {
            // Store current scroll position
            const scrollY = window.scrollY;
            
            currentGameType = type;
            maxAttempts = attemptsConfig[type];
            attemptsUsed = 0;
            
            // Update active filter item
            document.querySelectorAll('.filter-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-game-type="${type}"]`).classList.add('active');
            
            // Update game title
            document.getElementById('game-title').textContent = `${type}-Number Prediction`;
            
            // Update instruction
            document.getElementById('game-instruction').textContent = `Select ${type} numbers (0-9) in the correct sequence`;
            
            // Update game type hidden input
            document.getElementById('game-type').value = type;
            
            // Update odds display
            document.getElementById('odds-display').textContent = `${odds[type]}.00x`;
            
            // Update attempts display
            const remainingAttemptsElem = document.getElementById('remaining-attempts');
            if (remainingAttemptsElem) {
                remainingAttemptsElem.textContent = maxAttempts;
            }
            
            // Recalculate potential win
            calculatePotentialWin();
            
            // Rebuild number inputs
            rebuildNumberInputs(type);
            
            // Restore scroll position (prevent scrolling down)
            window.scrollTo(0, Math.min(scrollY, window.scrollY));
            
            // Check game status after switching (in case user has active game)
            checkGameStatus();
        }
        
        // Make function globally accessible
        window.switchGameType = switchGameType;

        // Rebuild number inputs based on game type
        function rebuildNumberInputs(count) {
            const container = document.getElementById('number-inputs-container');
            container.innerHTML = '';
            
            for (let i = 1; i <= count; i++) {
                const input = document.createElement('input');
                input.type = 'number';
                input.name = `guess${i}`;
                input.id = `guess${i}`;
                input.min = '0';
                input.max = '9';
                input.required = true;
                input.className = 'number-input';
                input.placeholder = '0';
                container.appendChild(input);
            }
            
            // Re-attach event listeners
            attachInputListeners();
            
            // Focus first input without scrolling
            if (container.firstChild) {
                const firstInput = container.firstChild;
                // Use setTimeout to ensure DOM is ready, then focus without scrolling
                setTimeout(() => {
                    const scrollY = window.scrollY;
                    firstInput.focus({ preventScroll: true });
                    // Restore scroll position if it changed
                    if (Math.abs(window.scrollY - scrollY) > 50) {
                        window.scrollTo(0, scrollY);
                    }
                }, 0);
            }
        }

        // Attach input listeners
        function attachInputListeners() {
            const inputs = document.querySelectorAll('.number-input');
            inputs.forEach((input, index, inputsArray) => {
                input.addEventListener('input', function() {
                    // Ensure value is between 0-9
                    if (this.value < 0) this.value = '';
                    if (this.value > 9) this.value = 9;
                    
                    // Auto-advance to next input
                    if (this.value.length === 1 && index < inputsArray.length - 1) {
                        inputsArray[index + 1].focus({ preventScroll: true });
                    }
                });
            });
        }

        // Show message in betting section
        function showBetMessage(message, type = 'info') {
            const messageArea = document.getElementById('bet-message-area');
            const messageElement = document.getElementById('bet-message');
            
            if (messageArea && messageElement) {
                messageElement.textContent = message;
                messageElement.className = `bet-message bet-message-${type}`;
                messageArea.style.display = 'block';
            }
        }

        // Hide message in betting section
        function hideBetMessage() {
            const messageArea = document.getElementById('bet-message-area');
            if (messageArea) {
                messageArea.style.display = 'none';
            }
        }

        // Reset to default view (for new bet after win/loss)
        function resetToDefaultView() {
            // Hide generated numbers display
            document.getElementById('generated-numbers-display').style.display = 'none';
            
            // Reset start game button (hidden initially)
            const startBtn = document.getElementById('start-game-btn');
            startBtn.style.display = 'none';
            startBtn.disabled = false;
            startBtn.textContent = 'Start Game';
            startBtn.classList.remove('started');
            
            // Hide bet amount display
            document.getElementById('bet-amount-display').style.display = 'none';
            
            // Show and enable bet amount section (Step 1)
            const betSection = document.querySelector('.bet-section');
            if (betSection) {
                betSection.style.display = 'block';
            }
            const betAmountInput = document.getElementById('bet-amount');
            if (betAmountInput) {
                betAmountInput.disabled = false;
                betAmountInput.value = '';
            }
            
            // Reset attempts selector (hidden, will show when bet amount entered)
            const attemptsSelector = document.getElementById('attempts-selector-step');
            if (attemptsSelector) {
                attemptsSelector.style.display = 'none';
            }
            const attemptsSelect = document.getElementById('attempts-select');
            if (attemptsSelect) {
                attemptsSelect.value = '';
            }
            
            // Hide attempts info
            const attemptsInfo = document.querySelector('.attempts-info');
            if (attemptsInfo) {
                attemptsInfo.style.display = 'none';
            }
            
            // Hide number selection section
            const numberSection = document.getElementById('number-selection-section');
            if (numberSection) {
                numberSection.style.display = 'none';
            }
            
            // Hide form actions
            const formActions = document.getElementById('form-actions-section');
            if (formActions) {
                formActions.style.display = 'none';
            }
            
            // Clear number inputs
            document.querySelectorAll('.number-input').forEach(input => {
                input.value = '';
            });
            
            // Reset instruction text
            document.getElementById('game-instruction').textContent = 'Step 1: Select your bet amount';
            
            // Reset attempts display
            document.getElementById('remaining-attempts').textContent = '3';
            
            // Reset form
            const form = document.getElementById('guess-form');
            const submitBtn = form.querySelector('.btn-place-bet');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Check';
            submitBtn.style.opacity = '1';
            submitBtn.style.cursor = 'pointer';
            
            // Hide message after a delay
            setTimeout(() => {
                hideBetMessage();
            }, 5000);
        }

        // Update attempts display (using server-side values only)
        function updateAttemptsDisplay(remainingAttempts) {
            document.getElementById('remaining-attempts').textContent = remainingAttempts;
            
            // Disable form if no attempts left
            const form = document.getElementById('guess-form');
            const submitBtn = form.querySelector('.btn-place-bet');
            
            if (remainingAttempts <= 0) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'No Attempts Left';
                submitBtn.style.opacity = '0.5';
                submitBtn.style.cursor = 'not-allowed';
            } else {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Check';
                submitBtn.style.opacity = '1';
                submitBtn.style.cursor = 'pointer';
            }
        }

        // Form submission handler
        document.getElementById('guess-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form data
            const formData = new FormData(this);
            const submitBtn = this.querySelector('.btn-place-bet');
            const originalText = submitBtn.textContent;
            
            // Disable button during submission
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            hideBetMessage();
            
            let result = null;
            try {
                // Convert FormData to object
                const data = {};
                formData.forEach((value, key) => {
                    data[key] = value;
                });
                
                // Handle demo mode locally
                if (playMode === 'demo') {
                    const demoGame = JSON.parse(sessionStorage.getItem('demo_game') || '{}');
                    if (!demoGame.numbers) {
                        showBetMessage('Please start a game first', 'error');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                        return;
                    }
                    
                    // Get user's guess
                    const userGuess = [];
                    for (let i = 1; i <= demoGame.gameType; i++) {
                        userGuess.push(parseInt(data[`guess${i}`]));
                    }
                    
                    // Check if guess matches
                    let correctPositions = 0;
                    let correctNumbers = 0;
                    
                    for (let i = 0; i < userGuess.length; i++) {
                        if (userGuess[i] === demoGame.numbers[i]) {
                            correctPositions++;
                        } else if (demoGame.numbers.includes(userGuess[i])) {
                            correctNumbers++;
                        }
                    }
                    
                    attemptsUsed++;
                    const remainingAttempts = demoGame.attempts - attemptsUsed;
                    updateAttemptsDisplay(remainingAttempts);
                    
                    const exactMatch = correctPositions === demoGame.gameType;
                    
                    if (exactMatch) {
                        // Win!
                        const winAmount = demoGame.betAmount * demoGame.odds;
                        demoBalance += winAmount;
                        saveDemoBalance();
                        
                        result = {
                            success: true,
                            gameWon: true,
                            winAmount: winAmount,
                            betAmount: demoGame.betAmount,
                            message: `ðŸŽ‰ Congratulations! You won â‚¦${winAmount.toLocaleString()}!`
                        };
                        
                        showBetMessage(result.message, 'success');
                        showCelebrationModal(winAmount, demoGame.betAmount);
                        sessionStorage.removeItem('demo_game');
                    } else if (remainingAttempts <= 0) {
                        // Lost
                        result = {
                            success: true,
                            gameLost: true,
                            message: `Game over! The correct numbers were: ${demoGame.numbers.join(' ')}`
                        };
                        
                        showBetMessage(result.message, 'error');
                        sessionStorage.removeItem('demo_game');
                        setTimeout(() => {
                            resetToDefaultView();
                        }, 5000);
                    } else {
                        // Continue playing
                        result = {
                            success: true,
                            remainingAttempts: remainingAttempts,
                            message: `${correctPositions} correct position(s), ${correctNumbers} correct number(s) in wrong position. ${remainingAttempts} attempt(s) remaining.`
                        };
                        
                        showBetMessage(result.message, 'info');
                    }
                    
                    // Clear inputs
                    setTimeout(() => {
                        document.querySelectorAll('.number-input').forEach(input => {
                            input.value = '';
                        });
                        if (document.getElementById('guess1')) {
                            document.getElementById('guess1').focus({ preventScroll: true });
                        }
                    }, 100);
                    
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }
                
                // Real money mode - send AJAX request
                const response = await fetch('/guess', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(data)
                });
                
                result = await response.json();
                
                if (result.success) {
                    // Update attempts display using server-side value only
                    updateAttemptsDisplay(result.remainingAttempts);
                    
                    // Show feedback message in betting section
                    if (result.gameWon) {
                        showBetMessage(result.message, 'success');
                        // Show celebratory popup modal
                        showCelebrationModal(result.winAmount, result.betAmount);
                        // Update balance display
                        updateBalanceDisplay(result.winAmount);
                        // Reset to default view after modal is closed (handled in closeCelebrationModal)
                    } else if (result.gameLost) {
                        showBetMessage(result.message, 'error');
                        // Move game to history and reload
                        setTimeout(async () => {
                            try {
                                await fetch('/clear-completed-game', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    }
                                });
                                await loadGameHistory();
                            } catch (error) {
                                console.error('Error moving completed game:', error);
                            }
                            resetToDefaultView();
                        }, 5000);
                    } else {
                        showBetMessage(result.message, 'info');
                    }
                    
                    // Clear inputs after submission
                    setTimeout(() => {
                        document.querySelectorAll('.number-input').forEach(input => {
                            input.value = '';
                        });
                        if (document.getElementById('guess1')) {
                            document.getElementById('guess1').focus({ preventScroll: true });
                        }
                    }, 100);
                    
                } else {
                    // Show error message in betting section
                    showBetMessage(result.error || 'Failed to process your bet. Please try again.', 'error');
                    
                    if (result.noActiveGame || result.gameEnded) {
                        // Reset to default view
                        setTimeout(() => {
                            resetToDefaultView();
                        }, 3000);
                    } else {
                        // Re-enable button on error
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                }
                
            } catch (error) {
                console.error('Error submitting bet:', error);
                showBetMessage('An error occurred. Please try again.', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // Quick bet buttons
        document.querySelectorAll('.quick-bet').forEach(btn => {
            btn.addEventListener('click', function() {
                const amount = this.textContent.replace('â‚¦', '').replace(',', '');
                const betAmountInput = document.getElementById('bet-amount');
                betAmountInput.value = amount;
                
                // Trigger the input event to show step 2
                const event = new Event('input', { bubbles: true });
                betAmountInput.dispatchEvent(event);
            });
        });

        // Bet amount input listener with progressive UI flow
        document.getElementById('bet-amount').addEventListener('input', function() {
            const betAmount = parseFloat(this.value);
            const attemptsSelector = document.getElementById('attempts-selector-step');
            const instruction = document.getElementById('game-instruction');
            
            if (betAmount && betAmount > 0) {
                // Show step 2: attempts selector
                attemptsSelector.style.display = 'block';
                instruction.textContent = 'Step 2: Choose your number of attempts';
            } else {
                // Hide steps 2 and 3 if bet amount is cleared
                attemptsSelector.style.display = 'none';
                document.getElementById('start-game-btn').style.display = 'none';
                instruction.textContent = 'Step 1: Select your bet amount';
            }
            
            calculatePotentialWin();
        });


        // Initialize
        attachInputListeners();
        if (document.getElementById('guess1')) {
            document.getElementById('guess1').focus({ preventScroll: true });
        }
        
        // Ensure page starts from the top
        window.scrollTo(0, 0);

        // Bet Details Modal Functions
        function showBetDetails(gameType, userNumbers, winningNumbers, won, betAmount, winAmount) {
            const modal = document.getElementById('bet-modal');
            const gameTypeText = gameType === '4' ? '4-Number Prediction' : '3-Number Prediction';
            const resultText = won ? 'Successfully Predicted âœ“' : 'Failed to Predict âœ—';
            const resultClass = won ? 'positive' : 'negative';
            
            document.getElementById('modal-game-type').textContent = gameTypeText;
            document.getElementById('modal-user-numbers').textContent = userNumbers.replace(/,/g, ' ');
            document.getElementById('modal-winning-numbers').textContent = winningNumbers.replace(/,/g, ' ');
            document.getElementById('modal-bet-amount').textContent = betAmount;
            document.getElementById('modal-result').textContent = resultText;
            document.getElementById('modal-result').className = `detail-value ${resultClass}`;
            document.getElementById('modal-win-amount').textContent = won ? winAmount : 'â‚¦0.00';
            document.getElementById('modal-win-amount').className = `detail-value ${won ? 'positive' : 'negative'}`;
            
            modal.style.display = 'flex';
        }

        function closeBetModal() {
            document.getElementById('bet-modal').style.display = 'none';
        }

        // Celebration Modal Functions
        function showCelebrationModal(winAmount, betAmount) {
            const modal = document.getElementById('celebration-modal');
            const winAmountElement = document.getElementById('celebration-win-amount');
            
            if (modal && winAmountElement) {
                winAmountElement.textContent = `â‚¦${winAmount.toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                modal.style.display = 'flex';
            }
        }

        async function closeCelebrationModal() {
            const modal = document.getElementById('celebration-modal');
            if (modal) {
                modal.style.display = 'none';
                
                // Move the completed game to history
                try {
                    await fetch('/clear-completed-game', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    // Reload history after moving game
                    await loadGameHistory();
                } catch (error) {
                    console.error('Error moving completed game:', error);
                }
                
                // Reset to default view after closing celebration modal
                resetToDefaultView();
                // Reload to ensure balance is updated
                window.location.reload();
            }
        }

        // Update balance display
        async function updateBalanceDisplay(winAmount) {
            try {
                // Fetch updated balance from server
                const response = await fetch('/get-game-status');
                const data = await response.json();
                
                if (data.balance !== undefined) {
                    const balanceElements = document.querySelectorAll('.balance-amount-nav, .balance-amount-large, #account-balance-top, #account-balance');
                    balanceElements.forEach(el => {
                        el.textContent = `â‚¦${data.balance.toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    });
                }
            } catch (error) {
                console.error('Error updating balance:', error);
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const betModal = document.getElementById('bet-modal');
            const celebrationModal = document.getElementById('celebration-modal');
            
            if (event.target === betModal) {
                closeBetModal();
            }
            if (event.target === celebrationModal) {
                closeCelebrationModal();
            }
        }

        // Check game status on page load
        async function checkGameStatus() {
            try {
                const response = await fetch('/get-game-status');
                const data = await response.json();
                
                // Update balance display if available
                if (data.balance !== undefined) {
                    const balanceElements = document.querySelectorAll('.balance-amount-nav, .balance-amount-large, #account-balance-top, #account-balance');
                    balanceElements.forEach(el => {
                        el.textContent = `â‚¦${data.balance.toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    });
                }
                
                // If game exists but status is won or lost, reset to default view (don't show celebration modal)
                if (data.success && data.status && (data.status === 'won' || data.status === 'lost')) {
                    // Just reset to default view - celebration modal should only show when user actually wins during gameplay
                    resetToDefaultView();
                    return;
                }
                
                if (data.success && data.hasActiveGame) {
                    // Game is active - show game interface
                    const startBtn = document.getElementById('start-game-btn');
                    startBtn.style.display = 'none';
                    startBtn.disabled = false;
                    startBtn.textContent = 'Start Game';
                    startBtn.classList.remove('started');
                    
                    document.getElementById('generated-numbers-display').style.display = 'block';
                    
                    // Show bet amount display
                    const betDisplay = document.getElementById('bet-amount-display');
                    const betAmountText = document.getElementById('current-bet-amount');
                    if (betDisplay && betAmountText && data.betAmount) {
                        betDisplay.style.display = 'block';
                        betAmountText.textContent = `â‚¦${data.betAmount.toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    }
                    
                    // Hide bet amount section completely
                    const betSection = document.querySelector('.bet-section');
                    if (betSection) {
                        betSection.style.display = 'none';
                    }
                    
                    // Disable bet amount input
                    const betAmountInput = document.getElementById('bet-amount');
                    if (betAmountInput) {
                        betAmountInput.disabled = true;
                    }
                    
                    // Hide attempts selector completely
                    const attemptsSelector = document.getElementById('attempts-selector-step');
                    if (attemptsSelector) {
                        attemptsSelector.style.display = 'none';
                    }
                    
                    // Show number selection section
                    const numberSection = document.getElementById('number-selection-section');
                    if (numberSection) {
                        numberSection.style.display = 'block';
                    }
                    
                    // Show form actions
                    const formActions = document.getElementById('form-actions-section');
                    if (formActions) {
                        formActions.style.display = 'flex';
                    }
                    
                    // Show attempts info
                    const attemptsInfo = document.querySelector('.attempts-info');
                    if (attemptsInfo) {
                        attemptsInfo.style.display = 'block';
                    }
                    
                    // Update instruction
                    const gameType = data.gameType || 4;
                    document.getElementById('game-instruction').textContent = `Select ${gameType} numbers (0-9) in the correct sequence`;
                    
                    // Update attempts display using server-side values only
                    const remainingAttempts = data.attempts - data.attemptsUsed;
                    updateAttemptsDisplay(remainingAttempts);
                    attemptsUsed = data.attemptsUsed;
                    maxAttempts = data.attempts;
                } else {
                    // No active game - reset to step 1
                    resetToDefaultView();
                    
                    const betAmountInput = document.getElementById('bet-amount');
                    if (betAmountInput) {
                        betAmountInput.disabled = false;
                    }
                }
            } catch (error) {
                console.error('Error checking game status:', error);
            }
        }

        // Start Game Button Handler
        document.getElementById('start-game-btn')?.addEventListener('click', async function() {
            const btn = this;
            const originalText = btn.textContent;
            
            // Check if bet amount is selected
            const betAmountInput = document.getElementById('bet-amount');
            const betAmount = parseFloat(betAmountInput.value);
            
            if (!betAmount || betAmount <= 0) {
                showBetMessage('You need to select an amount before you start a game', 'error');
                return;
            }
            
            // Check demo balance if in demo mode
            if (playMode === 'demo') {
                if (betAmount > demoBalance) {
                    showBetMessage('Insufficient demo balance. Please select a lower amount or reset your demo balance.', 'error');
                    return;
                }
            }
            
            hideBetMessage();
            
            btn.disabled = true;
            btn.textContent = 'Starting...';
            
            try {
                const gameType = document.getElementById('game-type').value || '4';
                
                // Handle demo mode locally
                if (playMode === 'demo') {
                    // Deduct from demo balance
                    demoBalance -= betAmount;
                    saveDemoBalance();
                    
                    // Simulate game start
                    // Show generated numbers display
                    const display = document.getElementById('generated-numbers-display');
                    if (display) {
                        display.style.display = 'block';
                    }
                    
                    // Hide start button
                    document.getElementById('start-game-btn').style.display = 'none';
                    
                    // Show bet amount display
                    const betDisplay = document.getElementById('bet-amount-display');
                    const betAmountText = document.getElementById('current-bet-amount');
                    if (betDisplay && betAmountText) {
                        betDisplay.style.display = 'block';
                        betAmountText.textContent = `â‚¦${betAmount.toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    }
                    
                    // Set attempts
                    maxAttempts = attemptsConfig[parseInt(gameType)];
                    attemptsUsed = 0;
                    updateAttemptsDisplay(maxAttempts);
                    
                    // Hide bet amount section completely
                    const betSection = document.querySelector('.bet-section');
                    if (betSection) {
                        betSection.style.display = 'none';
                    }
                    betAmountInput.disabled = true;
                    
                    // Hide attempts selector completely
                    const attemptsSelector = document.getElementById('attempts-selector-step');
                    if (attemptsSelector) {
                        attemptsSelector.style.display = 'none';
                    }
                    
                    // Show number selection section
                    const numberSection = document.getElementById('number-selection-section');
                    if (numberSection) {
                        numberSection.style.display = 'block';
                    }
                    
                    // Show form actions (Check and Clear buttons)
                    const formActions = document.getElementById('form-actions-section');
                    if (formActions) {
                        formActions.style.display = 'flex';
                    }
                    
                    // Show attempts info
                    const attemptsInfo = document.querySelector('.attempts-info');
                    if (attemptsInfo) {
                        attemptsInfo.style.display = 'block';
                    }
                    
                    // Update instruction
                    document.getElementById('game-instruction').textContent = `Select ${gameType} numbers (0-9) in the correct sequence`;
                    
                    // Store demo game data
                    sessionStorage.setItem('demo_game', JSON.stringify({
                        gameType: parseInt(gameType),
                        betAmount: betAmount,
                        attempts: selectedAttempts,
                        odds: currentOdds,
                        numbers: generateDemoNumbers(parseInt(gameType))
                    }));
                    
                    btn.disabled = false;
                    btn.textContent = originalText;
                    return;
                }
                
                // Real money mode - proceed with server request
                const response = await fetch('/start-game', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        gameType: gameType, 
                        betAmount: betAmount,
                        attempts: selectedAttempts,
                        odds: currentOdds
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show generated numbers display
                    const display = document.getElementById('generated-numbers-display');
                    if (display) {
                        display.style.display = 'block';
                    }
                    
                    // Hide start button
                    document.getElementById('start-game-btn').style.display = 'none';
                    
                    // Show bet amount display
                    const betDisplay = document.getElementById('bet-amount-display');
                    const betAmountText = document.getElementById('current-bet-amount');
                    if (betDisplay && betAmountText) {
                        betDisplay.style.display = 'block';
                        betAmountText.textContent = `â‚¦${data.betAmount.toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    }
                    
                    // Update attempts from database response
                    maxAttempts = data.attempts;
                    attemptsUsed = 0;
                    updateAttemptsDisplay(data.attempts); // Show attempts from database
                    
                    // Hide bet amount section completely
                    const betSection = document.querySelector('.bet-section');
                    if (betSection) {
                        betSection.style.display = 'none';
                    }
                    betAmountInput.disabled = true;
                    
                    // Hide attempts selector completely
                    const attemptsSelector = document.getElementById('attempts-selector-step');
                    if (attemptsSelector) {
                        attemptsSelector.style.display = 'none';
                    }
                    
                    // Show number selection section
                    const numberSection = document.getElementById('number-selection-section');
                    if (numberSection) {
                        numberSection.style.display = 'block';
                    }
                    
                    // Show form actions (Check and Clear buttons)
                    const formActions = document.getElementById('form-actions-section');
                    if (formActions) {
                        formActions.style.display = 'flex';
                    }
                    
                    // Show attempts info
                    const attemptsInfo = document.querySelector('.attempts-info');
                    if (attemptsInfo) {
                        attemptsInfo.style.display = 'block';
                    }
                    
                    // Update instruction
                    document.getElementById('game-instruction').textContent = `Select ${gameType} numbers (0-9) in the correct sequence`;
                    
                    // Update balance display if available
                    if (data.newBalance !== undefined) {
                        // Update balance in navigation if exists
                        const balanceElements = document.querySelectorAll('.balance-amount-nav, .balance-amount-large, #account-balance-top, #account-balance');
                        balanceElements.forEach(el => {
                            if (el) {
                                el.textContent = `â‚¦${data.newBalance.toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                            }
                        });
                    }
                } else {
                    if (data.requiresLogin) {
                        // Redirect to login
                        if (confirm('You need to log in to start a game. Would you like to go to the login page?')) {
                            window.location.href = '/login';
                        }
                    } else if (data.requiresBetAmount) {
                        alert('Please select an amount you would like to play with.');
                    } else {
                        alert(data.error || 'Failed to start game. Please try again.');
                    }
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            } catch (error) {
                console.error('Error starting game:', error);
                alert('An error occurred. Please try again.');
                btn.textContent = originalText;
                btn.disabled = false;
            }
        });
        
        // Store all history for filtering
        let allHistory = [];
        let currentFilter = 'all';

        // Load and display game history
        async function loadGameHistory() {
            try {
                const response = await fetch('/get-game-history');
                const data = await response.json();
                
                if (data.success && data.history) {
                    allHistory = data.history; // Store all history
                    filterHistory(currentFilter); // Apply current filter
                }
            } catch (error) {
                console.error('Error loading game history:', error);
            }
        }

        // Filter history by status
        function filterHistory(filter) {
            currentFilter = filter;
            
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-filter') === filter) {
                    tab.classList.add('active');
                }
            });
            
            // Filter the history
            let filteredHistory = allHistory;
            if (filter === 'won') {
                filteredHistory = allHistory.filter(item => item.status === 'won');
            } else if (filter === 'lost') {
                filteredHistory = allHistory.filter(item => item.status === 'lost');
            }
            
            // Update Recent Activity (show only 3 most recent)
            updateRecentActivity(filteredHistory.slice(0, 3));
            
            // Update Betting History table
            updateHistoryTable(filteredHistory);
        }

        // Update Recent Activity section
        function updateRecentActivity(activities) {
            const activityList = document.getElementById('activity-list');
            if (!activityList) return;
            
            if (activities.length === 0) {
                activityList.innerHTML = '<div class="activity-item"><p style="text-align: center; color: var(--text-secondary); padding: 20px;">No recent activity</p></div>';
                return;
            }
            
            activityList.innerHTML = activities.map(activity => {
                const isWin = activity.status === 'won';
                const userNumbers = activity.userNumbers ? activity.userNumbers.join(' ') : 'N/A';
                const winningNumbers = activity.numbers ? activity.numbers.join(' ') : 'N/A';
                const gameTypeText = activity.gameType === 4 ? '4-Number Prediction' : '3-Number Prediction';
                const winAmount = activity.winAmount || 0;
                const betAmount = activity.betAmount || 0;
                const timeAgo = formatTimeAgo(activity.completedAt || activity.createdAt);
                
                return `
                    <div class="activity-item clickable" 
                         onclick="showBetDetails('${activity.gameType}', '${activity.userNumbers ? activity.userNumbers.join(',') : ''}', '${activity.numbers ? activity.numbers.join(',') : ''}', ${isWin}, 'â‚¦${betAmount.toLocaleString()}', 'â‚¦${winAmount.toLocaleString()}')">
                        <div class="activity-icon ${isWin ? 'win' : 'loss'}">${isWin ? 'âœ“' : 'âœ—'}</div>
                        <div class="activity-details">
                            <h4>${gameTypeText}</h4>
                            <p>${isWin ? `Won â‚¦${winAmount.toLocaleString()}` : `Lost â‚¦${betAmount.toLocaleString()}`}</p>
                            <span class="activity-time">${timeAgo}</span>
                        </div>
                        <div class="activity-amount ${isWin ? 'positive' : 'negative'}">${isWin ? '+' : '-'}â‚¦${isWin ? winAmount.toLocaleString() : betAmount.toLocaleString()}</div>
                    </div>
                `;
            }).join('');
        }

        // Update History Table
        function updateHistoryTable(history) {
            const tableBody = document.getElementById('history-table-body');
            if (!tableBody) return;
            
            if (history.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--text-secondary);">No betting history</td></tr>';
                return;
            }
            
            tableBody.innerHTML = history.map(activity => {
                const isWin = activity.status === 'won';
                const userNumbers = activity.userNumbers ? activity.userNumbers.join(' ') : 'N/A';
                const date = formatDate(activity.completedAt || activity.createdAt);
                const gameTypeText = activity.gameType === 4 ? '4-Number' : '3-Number';
                const winAmount = activity.winAmount || 0;
                const betAmount = activity.betAmount || 0;
                
                return `
                    <tr class="${isWin ? 'win-row' : 'loss-row'}">
                        <td>${date}</td>
                        <td>${gameTypeText}</td>
                        <td><span class="bet-numbers">${userNumbers}</span></td>
                        <td>â‚¦${betAmount.toLocaleString()}</td>
                        <td><span class="status-badge ${isWin ? 'win' : 'loss'}">${isWin ? 'Won' : 'Lost'}</span></td>
                        <td class="${isWin ? 'positive' : 'negative'}">${isWin ? 'â‚¦' + winAmount.toLocaleString() : '-â‚¦' + betAmount.toLocaleString()}</td>
                    </tr>
                `;
            }).join('');
        }

        // Format time ago
        function formatTimeAgo(timestamp) {
            if (!timestamp) return 'Unknown';
            
            const now = Date.now();
            const time = typeof timestamp === 'object' && timestamp.val ? timestamp.val : timestamp;
            const diff = now - time;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 60) return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
            if (hours < 24) return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
            return `${days} day${days !== 1 ? 's' : ''} ago`;
        }

        // Format date
        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown';
            
            const time = typeof timestamp === 'object' && timestamp.val ? timestamp.val : timestamp;
            const date = new Date(time);
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        // Check game status on page load
        checkGameStatus();
        // Load game history on page load
        loadGameHistory();
        
        // Mobile menu functionality
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const mobileMenuClose = document.getElementById('mobile-menu-close');
        const mobileMenu = document.getElementById('mobile-menu');
        const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
        
        function openMobileMenu() {
            mobileMenu.classList.add('active');
            mobileMenuOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeMobileMenu() {
            mobileMenu.classList.remove('active');
            mobileMenuOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }
        
        if (mobileMenuToggle) {
            mobileMenuToggle.addEventListener('click', openMobileMenu);
        }
        
        if (mobileMenuClose) {
            mobileMenuClose.addEventListener('click', closeMobileMenu);
        }
        
        if (mobileMenuOverlay) {
            mobileMenuOverlay.addEventListener('click', closeMobileMenu);
        }
        
        // Close mobile menu on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && mobileMenu.classList.contains('active')) {
                closeMobileMenu();
            }
        });
    </script>
</body>
</html>

